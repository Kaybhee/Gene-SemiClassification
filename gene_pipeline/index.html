
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gene Signature Classifier</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
        h2 { text-align: center; }
        textarea { width: 100%; height: 100px; margin-bottom: 15px; }
        button { padding: 10px 20px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .result { margin-top: 20px; padding: 15px; background: #e9ffe9; border-radius: 6px; }
        .rag-box { margin-top: 15px; padding: 12px; background: #f0f8ff; border-left: 4px solid #0066cc; border-radius: 4px; }
        .rag-box h4 { margin: 0 0 8px 0; color: #0066cc; }
        .rag-box pre { background: #fff; padding: 8px; border-radius: 3px; overflow-x: auto; font-size: 0.85em; max-height: 300px; }
        table { border-collapse: collapse; width: 100%; }
        table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        table th { background: #007bff; color: #fff; }
        .expandable { cursor: pointer; color: #0066cc; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Gene Signature Classifier</h2>
        <form id="classifyForm">
            <label for="sample">Paste molecular sample (text):</label><br>
            <textarea id="sample" name="sample" required></textarea><br>
            <button type="submit">Classify</button>
        </form>
        <div id="result" class="result" style="display:none;"></div>
        <div id="error" style="display:none; margin-top:12px; color:#900;"></div>
        <hr style="margin:20px 0;" />
        <h3>CSV Batch Prediction</h3>
        <p>Upload a CSV containing a <code>feature</code> column or text columns to generate per-row predictions.</p>
        <input id="csvFile" type="file" accept=".csv" />
        <button id="uploadCsvBtn">Upload CSV & Predict</button>
        <div id="csvResult" style="display:none; margin-top:12px;"></div>
    </div>
    <script>
        document.getElementById('classifyForm').onsubmit = async function(e) {
            e.preventDefault();
            document.getElementById('error').style.display = 'none';
            const sample = document.getElementById('sample').value.trim();
            if(!sample){
                document.getElementById('error').textContent = 'Please provide a sample.';
                document.getElementById('error').style.display = 'block';
                return;
            }

            const resultEl = document.getElementById('result');
            resultEl.style.display = 'block';
            resultEl.innerHTML = '<em>Classifyingâ€¦</em>';

            try{
                const formData = new FormData();
                formData.append('sample', sample);
                const response = await fetch('http://127.0.0.1:8000/classify', {
                    method: 'POST',
                    body: formData
                });

                if(!response.ok){
                    const txt = await response.text();
                    throw new Error(`Server returned ${response.status}: ${txt}`);
                }

                const data = await response.json();
                const raw = data.predicted_signature_raw ?? data.predicted_signature ?? 'unknown';
                const mapped = data.predicted_signature ?? raw;
                const conf = (data.confidence !== null && data.confidence !== undefined) ? Number(data.confidence) : null;
                const genes = data.extracted_genes ?? [];
                const ragInsights = data.rag_insights ? JSON.parse(data.rag_insights) : null;

                let resultHtml = `
                    <b>Predicted Signature (mapped):</b> ${mapped} <br>
                    <b>Predicted Signature (raw):</b> ${raw} <br>
                    <b>Confidence:</b> ${conf !== null ? conf.toFixed(3) : 'N/A'} <br>
                    <b>Extracted Genes:</b> ${genes.length > 0 ? genes.join(', ') : 'None'}
                `;

                if(ragInsights){
                    resultHtml += `<div class="rag-box">
                        <h4>ðŸ”¬ Scientific Insights (RAG-Enhanced)</h4>
                        <p><b>${ragInsights.profile_name}:</b> ${ragInsights.profile_description}</p>
                    `;
                    if(ragInsights.summary){
                        resultHtml += `<p><b>Summary:</b> ${ragInsights.summary}</p>`;
                    }
                    if(ragInsights.inferred_contexts && ragInsights.inferred_contexts.length > 0){
                        resultHtml += `<p><b>Biological Contexts:</b> ${ragInsights.inferred_contexts.join('; ')}</p>`;
                    }
                    if(ragInsights.gene_annotations && ragInsights.gene_annotations.length > 0){
                        resultHtml += `<p><b>Gene Annotations:</b></p><ul>`;
                        for(const ann of ragInsights.gene_annotations){
                            resultHtml += `<li><b>${ann.symbol}</b> (${ann.full_name})<br/>Functions: ${ann.functions.join(', ')}</li>`;
                        }
                        resultHtml += `</ul>`;
                    }
                    resultHtml += `</div>`;
                }

                resultEl.innerHTML = resultHtml;
            }catch(err){
                document.getElementById('error').textContent = 'Error: ' + err.message;
                document.getElementById('error').style.display = 'block';
                resultEl.style.display = 'none';
            }
        };

        document.getElementById('uploadCsvBtn').onclick = async function(e){
            e.preventDefault();
            document.getElementById('error').style.display = 'none';
            const f = document.getElementById('csvFile').files[0];
            if(!f){
                document.getElementById('error').textContent = 'Please choose a CSV file to upload.';
                document.getElementById('error').style.display = 'block';
                return;
            }

            const csvEl = document.getElementById('csvResult');
            csvEl.style.display = 'block';
            csvEl.innerHTML = '<em>Uploading and predictingâ€¦</em>';

            try{
                const fd = new FormData();
                fd.append('file', f);
                const resp = await fetch('http://127.0.0.1:8000/predict', { method: 'POST', body: fd });
                if(!resp.ok){
                    const txt = await resp.text();
                    throw new Error(`Server returned ${resp.status}: ${txt}`);
                }
                const j = await resp.json();
                // render results
                if(!j.results || !Array.isArray(j.results)){
                    csvEl.innerHTML = `<pre>${JSON.stringify(j, null, 2)}</pre>`;
                    return;
                }
                let html = `<p>Rows: ${j.n_rows}</p>`;
                html += '<table border="1" cellpadding="6" style="border-collapse:collapse; width:100%;">';
                html += '<tr><th>Row</th><th>Prediction</th><th>Confidence</th><th>Genes</th><th>Biological Context</th></tr>';
                for(const r of j.results){
                    const prob = r.probability ? (Array.isArray(r.probability) ? r.probability.map(p=>p.toFixed? (typeof p==='number'? p.toFixed(3): p): p).join(', ') : (typeof r.probability === 'number' ? r.probability.toFixed(3) : JSON.stringify(r.probability))) : 'N/A';
                    const genes = r.extracted_genes ? r.extracted_genes.join(', ') : '';
                    const ragObj = r.rag_insights ? JSON.parse(r.rag_insights) : null;
                    const context = ragObj && ragObj.inferred_contexts ? ragObj.inferred_contexts.join('; ') : '';
                    const clickId = `row_${r.row}`;
                    html += `<tr><td>${r.row}</td><td><b>${r.prediction}</b></td><td>${prob}</td><td>${genes}</td><td><span class="expandable" id="expand_${clickId}">${context ? context.substring(0, 40) + '...' : 'None'}</span><div id="${clickId}" style="display:none; margin-top:8px; padding:8px; background:#f0f8ff; border-radius:3px;"><pre>${ragObj ? JSON.stringify(ragObj, null, 2) : 'No insights'}</pre></div></td></tr>`;
                }
                html += '</table>';
                csvEl.innerHTML = html;
                
                // Attach click handlers for expandable RAG insights
                for(const r of j.results){
                    const clickId = `row_${r.row}`;
                    const expandBtn = document.getElementById(`expand_${clickId}`);
                    const detailDiv = document.getElementById(clickId);
                    if(expandBtn && detailDiv){
                        expandBtn.onclick = function(e){
                            e.stopPropagation();
                            detailDiv.style.display = detailDiv.style.display === 'none' ? 'block' : 'none';
                            expandBtn.textContent = detailDiv.style.display === 'none' ? 'Show' : 'Hide';
                        };
                    }
                }
            }catch(err){
                document.getElementById('error').textContent = 'CSV upload error: ' + err.message;
                document.getElementById('error').style.display = 'block';
                csvEl.style.display = 'none';
            }
        };
    </script>
</body>
</html>
