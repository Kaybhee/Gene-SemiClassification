<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gene Signature Classifier</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-white font-sans min-h-screen flex flex-col items-center py-12">

  <div class="w-full max-w-4xl bg-gray-900 rounded-2xl shadow-xl p-8">
    <h2 class="text-3xl font-bold text-center text-blue-400 mb-6">Gene Signature Classifier</h2>
    
    <form id="classifyForm" class="mb-8">
      <label for="sample" class="block mb-2 font-semibold">Paste molecular sample:</label>
      <textarea id="sample" name="sample" required class="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-4"></textarea>
      <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-full transition duration-200">Classify</button>
    </form>

    <div id="result" class="hidden mt-6 p-4 bg-green-900 rounded-lg"></div>
    <div id="error" class="hidden mt-4 text-red-500 font-semibold"></div>

    <hr class="my-8 border-gray-700" />

    <h3 class="text-2xl font-bold text-blue-400 mb-4">CSV Batch Prediction</h3>
    <p class="mb-4">Upload a CSV containing a <code class="bg-gray-700 px-1 py-0.5 rounded">feature</code> column or text columns to generate per-row predictions.</p>
    <div class="flex flex-col md:flex-row gap-4 mb-4">
      <input id="csvFile" type="file" accept=".csv" class="text-gray-900 p-2 rounded-lg flex-1"/>
      <button id="uploadCsvBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-full transition duration-200">Upload & Predict</button>
    </div>
    <div id="csvResult" class="hidden mt-4 overflow-x-auto"></div>
  </div>

  <script>
    document.getElementById('classifyForm').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('error').style.display = 'none';
      const sample = document.getElementById('sample').value.trim();
      if(!sample){
        document.getElementById('error').textContent = 'Please provide a sample.';
        document.getElementById('error').style.display = 'block';
        return;
      }
      const resultEl = document.getElementById('result');
      resultEl.style.display = 'block';
      resultEl.innerHTML = '<em>Classifyingâ€¦</em>';

      try {
        const formData = new FormData();
        formData.append('sample', sample);
        const response = await fetch('https://gene-semiclassification.onrender.com/classify', { method: 'POST', body: formData });

        if(!response.ok){
          const txt = await response.text();
          throw new Error(`Server returned ${response.status}: ${txt}`);
        }

        const data = await response.json();
        const raw = data.predicted_signature_raw ?? data.predicted_signature ?? 'unknown';
        const mapped = data.predicted_signature ?? raw;
        const conf = (data.confidence !== null && data.confidence !== undefined) ? Number(data.confidence) : null;
        const genes = data.extracted_genes ?? [];
        const ragInsights = data.rag_insights ? JSON.parse(data.rag_insights) : null;

        let resultHtml = `
          <p><strong>Predicted Signature (mapped):</strong> ${mapped}</p>
          <p><strong>Predicted Signature (raw):</strong> ${raw}</p>
          <p><strong>Confidence:</strong> ${conf !== null ? conf.toFixed(3) : 'N/A'}</p>
          <p><strong>Extracted Genes:</strong> ${genes.length > 0 ? genes.join(', ') : 'None'}</p>
        `;

        if(ragInsights){
          resultHtml += `
            <div class="mt-4 p-4 bg-blue-900 rounded-lg border-l-4 border-blue-400">
              <h4 class="font-bold text-blue-400 mb-2">ðŸ”¬ Scientific Insights (RAG-Enhanced)</h4>
              <p><strong>${ragInsights.profile_name}:</strong> ${ragInsights.profile_description}</p>
          `;
          if(ragInsights.summary){
            resultHtml += `<p><strong>Summary:</strong> ${ragInsights.summary}</p>`;
          }
          if(ragInsights.inferred_contexts && ragInsights.inferred_contexts.length > 0){
            resultHtml += `<p><strong>Biological Contexts:</strong> ${ragInsights.inferred_contexts.join('; ')}</p>`;
          }
          if(ragInsights.gene_annotations && ragInsights.gene_annotations.length > 0){
            resultHtml += `<p><strong>Gene Annotations:</strong></p><ul class="list-disc ml-6">`;
            for(const ann of ragInsights.gene_annotations){
              resultHtml += `<li><strong>${ann.symbol}</strong> (${ann.full_name}) - Functions: ${ann.functions.join(', ')}</li>`;
            }
            resultHtml += `</ul>`;
          }
          resultHtml += `</div>`;
        }

        resultEl.innerHTML = resultHtml;
      } catch(err){
        document.getElementById('error').textContent = 'Error: ' + err.message;
        document.getElementById('error').style.display = 'block';
        resultEl.style.display = 'none';
      }
    };

    document.getElementById('uploadCsvBtn').onclick = async function(e){
      e.preventDefault();
      document.getElementById('error').style.display = 'none';
      const f = document.getElementById('csvFile').files[0];
      if(!f){
        document.getElementById('error').textContent = 'Please choose a CSV file to upload.';
        document.getElementById('error').style.display = 'block';
        return;
      }
      const csvEl = document.getElementById('csvResult');
      csvEl.style.display = 'block';
      csvEl.innerHTML = '<em>Uploading and predictingâ€¦</em>';

      try {
        const fd = new FormData();
        fd.append('file', f);
        const resp = await fetch('https://gene-semiclassification.onrender.com/predict', { method: 'POST', body: fd });
        if(!resp.ok){
          const txt = await resp.text();
          throw new Error(`Server returned ${resp.status}: ${txt}`);
        }
        const j = await resp.json();
        if(!j.results || !Array.isArray(j.results)){
          csvEl.innerHTML = `<pre>${JSON.stringify(j, null, 2)}</pre>`;
          return;
        }

        let html = `<p>Rows: ${j.n_rows}</p>`;
        html += '<div class="overflow-x-auto"><table class="min-w-full text-white"><thead><tr class="bg-blue-500"><th class="p-2">Row</th><th class="p-2">Prediction</th><th class="p-2">Confidence</th><th class="p-2">Genes</th><th class="p-2">Biological Context</th></tr></thead><tbody>';
        for(const r of j.results){
          const prob = r.probability ? (Array.isArray(r.probability) ? r.probability.map(p=>p.toFixed? (typeof p==='number'? p.toFixed(3): p): p).join(', ') : (typeof r.probability === 'number' ? r.probability.toFixed(3) : JSON.stringify(r.probability))) : 'N/A';
          const genes = r.extracted_genes ? r.extracted_genes.join(', ') : '';
          const ragObj = r.rag_insights ? JSON.parse(r.rag_insights) : null;
          const context = ragObj && ragObj.inferred_contexts ? ragObj.inferred_contexts.join('; ') : '';
          const clickId = `row_${r.row}`;
          html += `<tr class="border-b border-gray-700"><td class="p-2">${r.row}</td><td class="p-2 font-bold">${r.prediction}</td><td class="p-2">${prob}</td><td class="p-2">${genes}</td><td class="p-2"><span class="cursor-pointer text-blue-400 underline" id="expand_${clickId}">${context ? context.substring(0, 40) + '...' : 'None'}</span><div id="${clickId}" class="hidden mt-2 p-2 bg-blue-900 rounded">${ragObj ? JSON.stringify(ragObj, null, 2) : 'No insights'}</div></td></tr>`;
        }
        html += '</tbody></table></div>';
        csvEl.innerHTML = html;

        for(const r of j.results){
          const clickId = `row_${r.row}`;
          const expandBtn = document.getElementById(`expand_${clickId}`);
          const detailDiv = document.getElementById(clickId);
          if(expandBtn && detailDiv){
            expandBtn.onclick = function(e){
              e.stopPropagation();
              detailDiv.classList.toggle('hidden');
              expandBtn.textContent = detailDiv.classList.contains('hidden') ? 'Show' : 'Hide';
            };
          }
        }
      } catch(err){
        document.getElementById('error').textContent = 'CSV upload error: ' + err.message;
        document.getElementById('error').style.display = 'block';
        csvEl.style.display = 'none';
      }
    };
  </script>
</body>
</html>
